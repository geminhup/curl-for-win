---
# yamllint disable rule:line-length
branches:
  only:
    - master
    - dev-travis
    - test-travis
notifications:
  email: false
git:
  depth: 8
language: c

matrix:
  include:
    - os: linux
      dist: trusty
      sudo: required
      group: edge
      compiler: mingw-clang
      services: [docker]
      # https://hub.docker.com/_/debian/
      env: DOCKER_IMAGE=debian:stable-backports

before_install:
  - |
    time docker pull "${DOCKER_IMAGE}"
    time docker run -it -v "${PWD}:${PWD}" -w "${PWD}" \
      --env-file <(env | grep -E '^(TRAVIS_|BINTRAY_|GPG_|VIRUSTOTAL_|CODESIGN_|CC)') \
      "${DOCKER_IMAGE}" sh -c '
      cat /etc/*-release
      ulimit -a
      df -h
      [ "${CC}" = 'mingw-clang' ] && _optpkg='clang'
      [ "${TRAVIS_BRANCH#*dev*}" != "${TRAVIS_BRANCH}" ] && _optpkg="${_optpkg} autoconf automake libtool"
      dpkg --add-architecture i386
      apt-get -qq update
      apt-get -qq install \
        curl git make python3-pip \
        binutils-mingw-w64 gcc-mingw-w64 ${_optpkg} cmake \
        zip time jq dos2unix osslsigncode wine64 wine32
      ./_build.sh'
